name: Deploy with Rate Limit Check

on:
  push:
    branches: [main, staging]
  pull_request:
    types: [opened, synchronize, ready_for_review]

jobs:
  check-rate-limit:
    name: Check Vercel Rate Limit
    runs-on: ubuntu-latest
    outputs:
      can-deploy: ${{ steps.check.outputs.can-deploy }}
      deployment-count: ${{ steps.check.outputs.deployment-count }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check deployment usage
        id: check
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        run: |
          # Simple check using Vercel API
          RESPONSE=$(curl -s -H "Authorization: Bearer $VERCEL_TOKEN" \
            "https://api.vercel.com/v6/deployments?limit=1&teamId=$VERCEL_ORG_ID")

          # Count deployments from last 24 hours
          SINCE=$(date -u -d '24 hours ago' +%Y-%m-%dT%H:%M:%S.000Z)
          COUNT_RESPONSE=$(curl -s -H "Authorization: Bearer $VERCEL_TOKEN" \
            "https://api.vercel.com/v6/deployments?since=$SINCE&teamId=$VERCEL_ORG_ID&limit=0")

          # Extract pagination info using jq for reliable JSON parsing
          if command -v jq &> /dev/null; then
            TOTAL=$(echo "$COUNT_RESPONSE" | jq -r '.pagination.count // 0')
          else
            # Fallback to grep if jq is not available
            TOTAL=$(echo "$COUNT_RESPONSE" | grep -o '"pagination":{"count":[0-9]*' | grep -o '[0-9]*$' || echo "0")
          fi

          echo "Deployment count (last 24h): $TOTAL"
          echo "deployment-count=$TOTAL" >> $GITHUB_OUTPUT

          if [ "$TOTAL" -ge "95" ]; then
            echo "⚠️ Approaching Vercel rate limit ($TOTAL/100 deployments)"
            echo "can-deploy=false" >> $GITHUB_OUTPUT
          else
            echo "✅ Within rate limit ($TOTAL/100 deployments)"
            echo "can-deploy=true" >> $GITHUB_OUTPUT
          fi

  deploy:
    name: Deploy to Vercel
    needs: check-rate-limit
    if: needs.check-rate-limit.outputs.can-deploy == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Deploy to Vercel
        id: deploy
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          # Install Vercel CLI
          npm i -g vercel

          # Determine environment and production flag based on branch
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENVIRONMENT="production"
            PROD_FLAG="--prod"
          else
            ENVIRONMENT="preview"
            PROD_FLAG=""
          fi

          # Pull Vercel environment information
          vercel pull --yes --environment="${ENVIRONMENT}" --token="${VERCEL_TOKEN}"

          # Build the project
          vercel build ${PROD_FLAG} --token="${VERCEL_TOKEN}"

          # Deploy and capture the URL
          DEPLOYMENT_URL=$(vercel deploy --prebuilt ${PROD_FLAG} --token="${VERCEL_TOKEN}")
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT

  notify-rate-limit:
    name: Notify Rate Limit
    needs: check-rate-limit
    if: needs.check-rate-limit.outputs.can-deploy == 'false'
    runs-on: ubuntu-latest

    steps:
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `⚠️ **Vercel Deployment Skipped**\n\nRate limit approaching or exceeded (${{ needs.check-rate-limit.outputs.deployment-count }}/100 deployments in last 24 hours).\n\n**Options:**\n1. Wait a few hours for the limit to reset\n2. Deploy manually using: \`vercel\`\n3. Upgrade to [Vercel Pro](https://vercel.com/pricing) for unlimited deployments\n\nThe build and tests passed successfully - only the preview deployment was skipped.`
            });

      - name: Set workflow status
        run: |
          echo "⚠️ Deployment skipped due to rate limit"
          echo "Current usage: ${{ needs.check-rate-limit.outputs.deployment-count }}/100"
          exit 0  # Don't fail the workflow
