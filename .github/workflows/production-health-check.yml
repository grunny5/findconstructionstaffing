name: Production Health Check

on:
  workflow_run:
    workflows: ['Deploy to Vercel']
    types:
      - completed
    branches:
      - main

jobs:
  health-check:
    name: Verify Production Deployment
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Wait for deployment propagation
        run: sleep 30

      - name: Health check production site
        id: health
        run: |
          PRODUCTION_URL="https://findconstructionstaffing.com"

          # Check main page
          MAIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $PRODUCTION_URL)
          echo "main-status=$MAIN_STATUS" >> $GITHUB_OUTPUT

          # Check API endpoint
          API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $PRODUCTION_URL/api/agencies)
          echo "api-status=$API_STATUS" >> $GITHUB_OUTPUT

          # Check critical pages
          RECRUITERS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $PRODUCTION_URL/recruiters)
          echo "recruiters-status=$RECRUITERS_STATUS" >> $GITHUB_OUTPUT

          # Determine overall health
          if [ "$MAIN_STATUS" = "200" ] && [ "$API_STATUS" = "200" ] && [ "$RECRUITERS_STATUS" = "200" ]; then
            echo "health=healthy" >> $GITHUB_OUTPUT
            echo "âœ… All health checks passed"
          else
            echo "health=unhealthy" >> $GITHUB_OUTPUT
            echo "âŒ Health checks failed"
            echo "Main page: $MAIN_STATUS"
            echo "API: $API_STATUS"
            echo "Recruiters page: $RECRUITERS_STATUS"
          fi

      - name: Update deployment status
        uses: actions/github-script@v7
        with:
          script: |
            const health = '${{ steps.health.outputs.health }}';
            const isHealthy = health === 'healthy';

            // Get the latest deployment
            const { data: deployments } = await github.rest.repos.listDeployments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              environment: 'production',
              per_page: 1
            });

            if (deployments.length > 0) {
              await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: deployments[0].id,
                state: isHealthy ? 'success' : 'failure',
                description: isHealthy 
                  ? 'Production deployment verified healthy' 
                  : 'Production health checks failed',
                environment_url: 'https://findconstructionstaffing.com'
              });
            }

      - name: Create issue if unhealthy
        if: steps.health.outputs.health == 'unhealthy'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Production Deployment Health Check Failed',
              body: `## Production Health Check Failed
              
              The latest production deployment has failed health checks.
              
              ### Failed Checks:
              - Main page: ${{ steps.health.outputs.main-status }}
              - API endpoint: ${{ steps.health.outputs.api-status }}
              - Recruiters page: ${{ steps.health.outputs.recruiters-status }}
              
              ### Immediate Actions:
              1. Check [Vercel Dashboard](https://vercel.com/dashboard) for deployment status
              2. Review [deployment logs](${{ github.event.workflow_run.html_url }})
              3. Consider rolling back to previous deployment
              
              ### Rollback Instructions:
              1. Go to Vercel Dashboard
              2. Select the FindConstructionStaffing project
              3. Navigate to Deployments tab
              4. Find the previous successful deployment
              5. Click "..." menu and select "Promote to Production"
              
              cc: @team`,
              labels: ['bug', 'production', 'urgent']
            });
