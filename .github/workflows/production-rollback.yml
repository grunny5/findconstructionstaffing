name: Production Rollback

on:
  workflow_dispatch:
    inputs:
      deployment_id:
        description: 'Deployment ID to rollback (leave empty for last deployment)'
        required: false
        type: string
      reason:
        description: 'Reason for rollback'
        required: true
        type: string

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  rollback:
    name: Rollback Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          
      - name: Install Vercel CLI
        run: npm install --global vercel@latest
        
      - name: Get deployment info
        id: deployment
        run: |
          if [ -z "${{ github.event.inputs.deployment_id }}" ]; then
            # Get the previous production deployment
            DEPLOYMENT_ID=$(vercel list --prod --token=${{ secrets.VERCEL_TOKEN }} | grep "Production" | sed -n '2p' | awk '{print $1}')
            echo "Rolling back to previous deployment: $DEPLOYMENT_ID"
          else
            DEPLOYMENT_ID="${{ github.event.inputs.deployment_id }}"
            echo "Rolling back to specified deployment: $DEPLOYMENT_ID"
          fi
          
          echo "deployment-id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          
      - name: Perform rollback
        id: rollback
        run: |
          # Promote the deployment to production
          vercel promote ${{ steps.deployment.outputs.deployment-id }} --token=${{ secrets.VERCEL_TOKEN }} --yes
          
          # Get the URL of the promoted deployment
          ROLLBACK_URL=$(vercel inspect ${{ steps.deployment.outputs.deployment-id }} --token=${{ secrets.VERCEL_TOKEN }} | grep "URL" | awk '{print $2}')
          echo "rollback-url=$ROLLBACK_URL" >> $GITHUB_OUTPUT
          
      - name: Create rollback record
        uses: actions/github-script@v7
        with:
          script: |
            // Create deployment record for rollback
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'production',
              description: `Rollback: ${{ github.event.inputs.reason }}`,
              auto_merge: false,
              required_contexts: [],
              task: 'rollback'
            });
            
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: 'success',
              environment_url: 'https://findconstructionstaffing.com',
              description: 'Rollback completed successfully'
            });
            
      - name: Create rollback issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ”„ Production Rollback: ${new Date().toISOString().split('T')[0]}`,
              body: `## Production Rollback Executed
              
              ### Rollback Details
              - **Initiated by**: @${{ github.actor }}
              - **Reason**: ${{ github.event.inputs.reason }}
              - **Rolled back to**: ${{ steps.deployment.outputs.deployment-id }}
              - **Timestamp**: ${new Date().toISOString()}
              
              ### Next Steps
              1. Verify production is stable
              2. Investigate the issue that caused the rollback
              3. Create hotfix if necessary
              4. Plan forward deployment
              
              ### Rollback URL
              ${{ steps.rollback.outputs.rollback-url }}
              
              cc: @team`,
              labels: ['production', 'rollback', 'incident']
            });
            
            console.log(`Rollback issue created: #${issue.data.number}`);
            
      - name: Generate rollback summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ”„ Production Rollback Complete
          
          ## Rollback Information
          - **Deployment ID**: ${{ steps.deployment.outputs.deployment-id }}
          - **Reason**: ${{ github.event.inputs.reason }}
          - **Initiated by**: ${{ github.actor }}
          - **URL**: ${{ steps.rollback.outputs.rollback-url }}
          
          ## Important
          - Production has been rolled back successfully
          - An issue has been created to track this incident
          - Please verify the application is functioning correctly
          
          ## Follow-up Actions
          1. Check application health
          2. Review logs for the failed deployment
          3. Create and test a fix
          4. Deploy the fix through normal CI/CD process
          EOF