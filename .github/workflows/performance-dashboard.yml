name: CI/CD Performance Dashboard

on:
  schedule:
    # Update dashboard daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-dashboard:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Collect metrics
        uses: actions/github-script@v7
        id: collect
        with:
          script: |
            const { owner, repo } = context.repo;

            // Get metrics for the past 30 days
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const allRuns = await github.paginate(
              github.rest.actions.listWorkflowRuns,
              { owner, repo, workflow_id: 'ci.yml', per_page: 100 },
              response => response.data
            );
            const runs = allRuns.filter(r => new Date(r.created_at) >= thirtyDaysAgo);

            // Group by date
            const dailyMetrics = {};

            for (const run of runs) {
              if (run.status !== 'completed') continue;
              
              const date = run.created_at.split('T')[0];
              if (!dailyMetrics[date]) {
                dailyMetrics[date] = {
                  runs: 0,
                  successful: 0,
                  totalDuration: 0,
                  durations: []
                };
              }
              
              dailyMetrics[date].runs++;
              if (run.conclusion === 'success') {
                dailyMetrics[date].successful++;
                const duration = new Date(run.updated_at) - new Date(run.created_at);
                dailyMetrics[date].durations.push(duration / 1000 / 60); // Convert to minutes
                dailyMetrics[date].totalDuration += duration / 1000 / 60;
              }
            }

            return dailyMetrics;

      - name: Generate dashboard
        env:
          METRICS_DATA: ${{ steps.collect.outputs.result }}
        run: |
          # Generate dashboard header
          cat > docs/ci-cd-dashboard.md << 'EOF'
          # CI/CD Performance Dashboard

          Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## 30-Day Performance Overview

          ![CI/CD Pipeline](https://github.com/${{ github.repository }}/actions/workflows/ci.yml/badge.svg)

          ## Daily Metrics

          | Date | Runs | Success Rate | Avg Duration |
          |------|------|--------------|--------------|
          EOF

          # Process metrics and add to table
          node -e "
            const metrics = JSON.parse(process.env.METRICS_DATA || '{}');
            const dates = Object.keys(metrics).sort().reverse().slice(0, 30);
            
            dates.forEach(date => {
              const data = metrics[date];
              const successRate = data.runs > 0
                ? ((data.successful / data.runs) * 100).toFixed(1) + '%'
                : 'N/A';
              const avgDuration = data.successful > 0
                ? (data.totalDuration / data.successful).toFixed(1) + ' min'
                : 'N/A';
              
              console.log(\`| \${date} | \${data.runs} | \${successRate} | \${avgDuration} |\`);
            });
            
            // Add summary statistics
            const totalRuns = Object.values(metrics).reduce((sum, d) => sum + d.runs, 0);
            const totalSuccess = Object.values(metrics).reduce((sum, d) => sum + d.successful, 0);
            const overallRate = totalRuns > 0
              ? ((totalSuccess / totalRuns) * 100).toFixed(1) + '%'
              : 'N/A';
            
            console.log('');
            console.log('## Summary Statistics');
            console.log('');
            console.log(\`- **Total Runs (30 days)**: \${totalRuns}\`);
            console.log(\`- **Overall Success Rate**: \${overallRate}\`);
            console.log(\`- **Data Collection Period**: \${dates[dates.length - 1]} to \${dates[0]}\`);
          " >> docs/ci-cd-dashboard.md

          echo "" >> docs/ci-cd-dashboard.md
          echo "---" >> docs/ci-cd-dashboard.md
          echo "*Dashboard updated automatically by GitHub Actions*" >> docs/ci-cd-dashboard.md

          echo "Dashboard generated at docs/ci-cd-dashboard.md"

      - name: Commit dashboard
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git pull --rebase --quiet
          git add docs/ci-cd-dashboard.md || true
          git commit -m "chore: update CI/CD performance dashboard" || echo "No changes to commit"
          git push || echo "No changes to push"
