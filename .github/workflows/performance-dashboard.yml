name: CI/CD Performance Dashboard

on:
  schedule:
    # Update dashboard daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-dashboard:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Collect metrics
        uses: actions/github-script@v7
        id: collect
        with:
          script: |
            const { owner, repo } = context.repo;
            
            // Get metrics for the past 30 days
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              workflow_id: 'ci.yml',
              created: `>=${thirtyDaysAgo.toISOString()}`,
              per_page: 100
            });
            
            // Group by date
            const dailyMetrics = {};
            
            for (const run of runs.data.workflow_runs) {
              if (run.status !== 'completed') continue;
              
              const date = run.created_at.split('T')[0];
              if (!dailyMetrics[date]) {
                dailyMetrics[date] = {
                  runs: 0,
                  successful: 0,
                  totalDuration: 0,
                  durations: []
                };
              }
              
              dailyMetrics[date].runs++;
              if (run.conclusion === 'success') {
                dailyMetrics[date].successful++;
                const duration = new Date(run.updated_at) - new Date(run.created_at);
                dailyMetrics[date].durations.push(duration / 1000 / 60); // Convert to minutes
                dailyMetrics[date].totalDuration += duration / 1000 / 60;
              }
            }
            
            return dailyMetrics;
            
      - name: Generate dashboard
        run: |
          cat > docs/CI_CD_DASHBOARD.md << 'EOF'
          # CI/CD Performance Dashboard
          
          Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ## 30-Day Performance Overview
          
          ![CI/CD Pipeline](https://github.com/${{ github.repository }}/actions/workflows/ci.yml/badge.svg)
          
          ## Daily Metrics
          
          | Date | Runs | Success Rate | Avg Duration |
          |------|------|--------------|--------------|
          EOF
          
          # Add metrics data (this would be populated from the collected metrics)
          echo "Dashboard generated at docs/CI_CD_DASHBOARD.md"
          
      - name: Commit dashboard
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/CI_CD_DASHBOARD.md || true
          git commit -m "chore: update CI/CD performance dashboard" || echo "No changes to commit"
          git push || echo "No changes to push"