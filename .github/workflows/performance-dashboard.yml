name: CI/CD Performance Dashboard

on:
  schedule:
    # Update dashboard daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-dashboard:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Collect metrics
        uses: actions/github-script@v7
        id: collect
        with:
          script: |
            const { owner, repo } = context.repo;
            
            // Get metrics for the past 30 days
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              workflow_id: 'ci.yml',
              created: `>=${thirtyDaysAgo.toISOString()}`,
              per_page: 100
            });
            
            // Group by date
            const dailyMetrics = {};
            
            for (const run of runs.data.workflow_runs) {
              if (run.status !== 'completed') continue;
              
              const date = run.created_at.split('T')[0];
              if (!dailyMetrics[date]) {
                dailyMetrics[date] = {
                  runs: 0,
                  successful: 0,
                  totalDuration: 0,
                  durations: []
                };
              }
              
              dailyMetrics[date].runs++;
              if (run.conclusion === 'success') {
                dailyMetrics[date].successful++;
                const duration = new Date(run.updated_at) - new Date(run.created_at);
                dailyMetrics[date].durations.push(duration / 1000 / 60); // Convert to minutes
                dailyMetrics[date].totalDuration += duration / 1000 / 60;
              }
            }
            
            return dailyMetrics;
            
      - name: Generate dashboard
        env:
          METRICS_DATA: ${{ steps.collect.outputs.result }}
        run: |
          # Generate dashboard header
          cat > docs/CI_CD_DASHBOARD.md << 'EOF'
          # CI/CD Performance Dashboard
          
          Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ## 30-Day Performance Overview
          
          ![CI/CD Pipeline](https://github.com/${{ github.repository }}/actions/workflows/ci.yml/badge.svg)
          
          ## Daily Metrics
          
          | Date | Runs | Success Rate | Avg Duration |
          |------|------|--------------|--------------|
          EOF
          
          # Process metrics and add to table
          echo "$METRICS_DATA" | node -e "
            const readline = require('readline');
            const rl = readline.createInterface({
              input: process.stdin,
              output: process.stdout,
              terminal: false
            });
            
            rl.on('line', (line) => {
              try {
                const metrics = JSON.parse(line);
                const dates = Object.keys(metrics).sort().reverse().slice(0, 30);
                
                dates.forEach(date => {
                  const data = metrics[date];
                  const successRate = data.runs > 0 
                    ? ((data.successful / data.runs) * 100).toFixed(1) + '%' 
                    : 'N/A';
                  const avgDuration = data.successful > 0 
                    ? (data.totalDuration / data.successful).toFixed(1) + ' min' 
                    : 'N/A';
                  
                  console.log(\`| \${date} | \${data.runs} | \${successRate} | \${avgDuration} |\`);
                });
                
                // Add summary statistics
                const totalRuns = Object.values(metrics).reduce((sum, d) => sum + d.runs, 0);
                const totalSuccess = Object.values(metrics).reduce((sum, d) => sum + d.successful, 0);
                const overallRate = totalRuns > 0 
                  ? ((totalSuccess / totalRuns) * 100).toFixed(1) + '%'
                  : 'N/A';
                
                console.log('');
                console.log('## Summary Statistics');
                console.log('');
                console.log(\`- **Total Runs (30 days)**: \${totalRuns}\`);
                console.log(\`- **Overall Success Rate**: \${overallRate}\`);
                console.log(\`- **Data Collection Period**: \${dates[dates.length - 1]} to \${dates[0]}\`);
              } catch (e) {
                console.error('Error parsing metrics:', e);
              }
            });
          " >> docs/CI_CD_DASHBOARD.md
          
          echo "" >> docs/CI_CD_DASHBOARD.md
          echo "---" >> docs/CI_CD_DASHBOARD.md
          echo "*Dashboard updated automatically by GitHub Actions*" >> docs/CI_CD_DASHBOARD.md
          
          echo "Dashboard generated at docs/CI_CD_DASHBOARD.md"
          
      - name: Commit dashboard
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/CI_CD_DASHBOARD.md || true
          git commit -m "chore: update CI/CD performance dashboard" || echo "No changes to commit"
          git push || echo "No changes to push"