name: Deploy to Vercel

on:
  push:
    branches: [main]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  issues: write
  pull-requests: write
  deployments: write
  checks: read

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  check-preview-gate:
    name: Check Preview Gate
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}

    steps:
      - name: Check deployment gate
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            // Check if preview protection workflow has run
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha,
              check_name: 'Preview Deployment Gate'
            });

            if (checks.check_runs.length === 0) {
              // Gate hasn't run yet, default to deploy
              core.setOutput('should-deploy', 'true');
              return;
            }

            const gate = checks.check_runs?.[0];
            const shouldDeploy = gate ? gate.conclusion === 'success' : true;
            core.setOutput('should-deploy', shouldDeploy.toString());

  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    needs: [check-preview-gate]
    if: |
      github.event_name == 'pull_request' && 
      github.event.pull_request.head.repo.full_name == github.repository &&
      needs.check-preview-gate.outputs.should-deploy == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Store PR number
        run: |
          echo "${{ github.event.pull_request.number }}" > pr-number.txt

      - name: Upload PR number
        uses: actions/upload-artifact@v4
        with:
          name: pr-number
          path: pr-number.txt

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check Vercel token availability
        id: check-token
        run: |
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "::error::VERCEL_TOKEN is not available. This typically happens for forked PRs."
            exit 1
          fi
          echo "Token is available"

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project Artifacts
        run: |
          set -eo pipefail  # Exit on error and pipe failures
          
          echo "Starting Vercel build..."
          
          # Capture output while preserving exit code
          BUILD_OUTPUT=$(vercel build --token=${{ secrets.VERCEL_TOKEN }} 2>&1) || BUILD_EXIT_CODE=$?
          
          # Always show build output for debugging
          echo "Build output:"
          echo "$BUILD_OUTPUT"
          
          # Handle build failure
          if [ -n "${BUILD_EXIT_CODE:-}" ] && [ "$BUILD_EXIT_CODE" -ne 0 ]; then
            echo "::error::Vercel build failed with exit code: $BUILD_EXIT_CODE"
            exit 1
          fi
          
          # Verify build artifacts
          if [ ! -d ".vercel/output" ] || [ ! -f ".vercel/output/config.json" ]; then
            echo "::error::Build completed but artifacts are missing"
            exit 1
          fi
          
          echo "âœ“ Build completed successfully"
          echo "âœ“ Build artifacts verified"

      - name: Deploy Project Artifacts to Vercel
        id: deploy
        run: |
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "Preview deployed to: $DEPLOYMENT_URL"

      - name: Create PR-specific alias
        id: alias
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          ALIAS_NAME="findconstructionstaffing-pr-${PR_NUMBER}"

          # Set alias for the deployment
          vercel alias set ${{ steps.deploy.outputs.deployment_url }} ${ALIAS_NAME} --token=${{ secrets.VERCEL_TOKEN }}

          ALIAS_URL="https://${ALIAS_NAME}.vercel.app"
          echo "alias_url=$ALIAS_URL" >> $GITHUB_OUTPUT
          echo "Alias created: $ALIAS_URL"

      - name: Create deployment record
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'preview',
              description: 'Preview deployment for PR #${{ github.event.pull_request.number }}',
              auto_merge: false,
              required_contexts: [],
              transient_environment: true,
              production_environment: false
            });

            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: 'success',
              environment_url: '${{ steps.alias.outputs.alias_url }}',
              description: 'Preview deployment successful'
            });

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentUrl = '${{ steps.deploy.outputs.deployment_url }}';
            const aliasUrl = '${{ steps.alias.outputs.alias_url }}';
            const comment = `### ðŸš€ Preview Deployment Ready!

            Your changes have been deployed to Vercel:

            ðŸ”— **Preview URL**: ${aliasUrl}
            ðŸ”— **Deployment URL**: ${deploymentUrl}

            | Status | Details |
            |--------|---------|
            | âœ… Build | Successful |
            | âœ… Deploy | Complete |
            | ðŸ” Environment | Preview |

            This preview will be automatically deleted when the PR is merged or closed.`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Preview Deployment Ready')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  deploy-production:
    name: Deploy Production
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [check-ci-status]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project Artifacts
        run: |
          set -eo pipefail  # Exit on error and pipe failures
          
          echo "Starting Vercel production build..."
          
          # Capture output while preserving exit code
          BUILD_OUTPUT=$(vercel build --prod --token=${{ secrets.VERCEL_TOKEN }} 2>&1) || BUILD_EXIT_CODE=$?
          
          # Always show build output for debugging
          echo "Build output:"
          echo "$BUILD_OUTPUT"
          
          # Handle build failure
          if [ -n "${BUILD_EXIT_CODE:-}" ] && [ "$BUILD_EXIT_CODE" -ne 0 ]; then
            echo "::error::Vercel build failed with exit code: $BUILD_EXIT_CODE"
            exit 1
          fi
          
          # Verify build artifacts
          if [ ! -d ".vercel/output" ] || [ ! -f ".vercel/output/config.json" ]; then
            echo "::error::Build completed but artifacts are missing"
            exit 1
          fi
          
          echo "âœ“ Build completed successfully"
          echo "âœ“ Build artifacts verified"

      - name: Deploy Project Artifacts to Vercel
        id: deploy
        run: |
          # Store current deployment for potential rollback using JSON output
          CURRENT_DEPLOYMENT_JSON=$(vercel list --prod --token=${{ secrets.VERCEL_TOKEN }} --output json || echo '{"deployments":[]}')
          CURRENT_DEPLOYMENT=$(echo "$CURRENT_DEPLOYMENT_JSON" | node -e "
            const data = JSON.parse(require('fs').readFileSync(0, 'utf-8'));
            const prodDeployments = (data.deployments || [])
              .filter(d => d.target === 'production' && d.state === 'READY')
              .sort((a, b) => new Date(b.created) - new Date(a.created));
            if (prodDeployments.length > 0) {
              console.log(prodDeployments[0].uid);
            }
          ")
          echo "previous_deployment=$CURRENT_DEPLOYMENT" >> $GITHUB_OUTPUT

          # Deploy to production
          echo "Deploying to production..."
          DEPLOYMENT_OUTPUT=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }} 2>&1)
          DEPLOYMENT_EXIT_CODE=$?
          
          if [ $DEPLOYMENT_EXIT_CODE -eq 0 ]; then
            # Strip ANSI escape codes from output first
            CLEAN_OUTPUT=$(echo "$DEPLOYMENT_OUTPUT" | sed 's/\x1b\[[0-9;]*m//g')
            
            # Extract URL from cleaned output using multiple patterns
            # Pattern 1: Direct URL on its own line
            DEPLOYMENT_URL=$(echo "$CLEAN_OUTPUT" | grep -E "^https://[a-zA-Z0-9.-]+\.vercel\.(app|sh)$" | tail -1)
            
            # Pattern 2: URL after "Ready!" or "Deployed to:"
            if [[ -z "$DEPLOYMENT_URL" ]]; then
              DEPLOYMENT_URL=$(echo "$CLEAN_OUTPUT" | grep -oE "(Ready!|Deployed to:)\s*https://[a-zA-Z0-9.-]+\.vercel\.(app|sh)" | grep -oE "https://[a-zA-Z0-9.-]+\.vercel\.(app|sh)" | tail -1)
            fi
            
            # Pattern 3: URL after "Inspect:"
            if [[ -z "$DEPLOYMENT_URL" ]]; then
              DEPLOYMENT_URL=$(echo "$CLEAN_OUTPUT" | grep -oE "Inspect:\s*https://[a-zA-Z0-9.-]+\.vercel\.(app|sh)" | grep -oE "https://[a-zA-Z0-9.-]+\.vercel\.(app|sh)" | tail -1)
            fi
            
            # Pattern 4: Any URL in the output (fallback)
            if [[ -z "$DEPLOYMENT_URL" ]]; then
              DEPLOYMENT_URL=$(echo "$CLEAN_OUTPUT" | grep -oE "https://[a-zA-Z0-9.-]+\.vercel\.(app|sh)" | tail -1)
            fi
            
            # For production, we know the URL
            if [[ -z "$DEPLOYMENT_URL" ]]; then
              DEPLOYMENT_URL="https://findconstructionstaffing.vercel.app"
            fi
            
            # Generate a deployment ID from timestamp
            DEPLOYMENT_ID="prod-$(date +%s)"

          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          echo "Production deployed to: $DEPLOYMENT_URL"

      - name: Create deployment record
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'production',
              description: 'Production deployment to Vercel',
              auto_merge: false,
              required_contexts: []
            });

      - name: Add deployment status
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentUrl = '${{ steps.deploy.outputs.deployment_url }}';

            // Get the deployment we just created
            const { data: deployments } = await github.rest.repos.listDeployments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              environment: 'production'
            });

            if (deployments.length > 0) {
              await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: deployments[0].id,
                state: 'success',
                environment_url: deploymentUrl,
                description: 'Deployment completed successfully'
              });
            }

      - name: Generate deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸš€ Production Deployment Complete

          ## Deployment Details
          - **Environment**: Production
          - **URL**: ${{ steps.deploy.outputs.deployment_url }}
          - **Deployment ID**: ${{ steps.deploy.outputs.deployment_id }}
          - **Previous Deployment**: ${{ steps.deploy.outputs.previous_deployment }}

          ## Commit Information
          - **SHA**: ${{ github.sha }}
          - **Author**: ${{ github.actor }}
          - **Message**: ${{ github.event.head_commit.message }}

          ## Next Steps
          1. Health checks will run automatically
          2. Monitor [Vercel Dashboard](https://vercel.com/dashboard)
          3. Check application logs for errors

          ## Rollback Instructions
          If issues are detected:
          \`\`\`bash
          vercel rollback ${{ steps.deploy.outputs.deployment_id }} --token=\$VERCEL_TOKEN
          \`\`\`
          EOF

      - name: Create deployment notification
        uses: actions/github-script@v7
        with:
          script: |
            const commit = context.payload.head_commit;
            const deploymentUrl = '${{ steps.deploy.outputs.deployment_url }}';

            // Create a deployment notification issue comment on the latest merged PR
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 5
            });

            const recentMergedPR = prs.find(pr => 
              pr.merged_at && 
              pr.merge_commit_sha === context.sha
            );

            if (recentMergedPR) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: recentMergedPR.number,
                body: `## ðŸŽ‰ Deployed to Production!
                
                Your changes have been successfully deployed to production.
                
                **Production URL**: https://findconstructionstaffing.com
                **Deployment URL**: ${deploymentUrl}
                
                Health checks are running and you'll be notified if any issues are detected.`
              });
            }

  check-ci-status:
    name: Check CI Status
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Check CI workflow status
        uses: actions/github-script@v7
        with:
          script: |
            // Get the latest CI workflow run for this commit
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci.yml',
              head_sha: context.sha,
              status: 'completed'
            });

            if (runs.workflow_runs.length === 0) {
              core.setFailed('No completed CI workflow found for this commit');
              return;
            }

            const latestRun = runs.workflow_runs[0];
            if (latestRun.conclusion !== 'success') {
              core.setFailed(`CI workflow failed with conclusion: ${latestRun.conclusion}`);
              return;
            }

            console.log('CI workflow passed successfully');
