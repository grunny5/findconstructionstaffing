name: Deploy to Vercel

on:
  push:
    branches: [main]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  issues: write
  pull-requests: write
  deployments: write
  checks: read

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  check-preview-gate:
    name: Check Preview Gate
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}

    steps:
      - name: Check deployment gate
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            // Check if preview protection workflow has run
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha,
              check_name: 'Preview Deployment Gate'
            });

            if (checks.check_runs.length === 0) {
              // Gate hasn't run yet, default to deploy
              core.setOutput('should-deploy', 'true');
              return;
            }

            const gate = checks.check_runs?.[0];
            const shouldDeploy = gate ? gate.conclusion === 'success' : true;
            core.setOutput('should-deploy', shouldDeploy.toString());

  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    needs: [check-preview-gate]
    if: |
      github.event_name == 'pull_request' && 
      github.event.pull_request.head.repo.full_name == github.repository &&
      needs.check-preview-gate.outputs.should-deploy == 'true'

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Store PR number
        run: |
          echo "${{ github.event.pull_request.number }}" > pr-number.txt

      - name: Upload PR number
        uses: actions/upload-artifact@v4
        with:
          name: pr-number
          path: pr-number.txt

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check Vercel token availability
        id: check-token
        run: |
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "::error::VERCEL_TOKEN is not available. This typically happens for forked PRs."
            exit 1
          fi
          echo "Token is available"

      - name: Install Vercel CLI
        run: |
          # Install Vercel CLI with proper error handling
          echo "Installing Vercel CLI..."
          npm install --global vercel@latest --loglevel=error 2>&1 | grep -v "npm warn deprecated" || true

          # Check if installation succeeded
          if ! command -v vercel &> /dev/null; then
            echo "::error::Failed to install Vercel CLI"
            exit 1
          fi

          # Verify installation
          echo "Verifying Vercel CLI installation..."
          vercel --version || {
            echo "::error::Vercel CLI not found after installation"
            exit 1
          }

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project Artifacts
        run: |
          set -e  # Exit on any error
          echo "Starting Vercel build..."

          # Run build without tee to avoid exit code issues
          vercel build --token=${{ secrets.VERCEL_TOKEN }} > build.log 2>&1 || BUILD_RESULT=$?

          # If BUILD_RESULT is not set, the command succeeded
          if [ -z "${BUILD_RESULT:-}" ]; then
            BUILD_RESULT=0
          fi

          # Display the build log
          cat build.log

          # Check if build failed
          if [ $BUILD_RESULT -ne 0 ]; then
            echo "::error::Vercel build command failed with exit code: $BUILD_RESULT"
            exit 1
          fi

          echo "âœ“ Vercel build command completed successfully"

          # Verify build artifacts
          if [ ! -d ".vercel/output" ]; then
            echo "::error::Build output directory not found"
            ls -la .vercel/ || true
            exit 1
          fi

          if [ ! -f ".vercel/output/config.json" ]; then
            echo "::error::Build config.json not found"
            ls -la .vercel/output/ || true
            exit 1
          fi

          echo "âœ“ Build completed successfully"
          echo "âœ“ Build artifacts verified"

          # Ensure we exit cleanly
          exit 0

      - name: Deploy Project Artifacts to Vercel
        id: deploy
        run: |
          set -e  # Exit on any error
          echo "Starting deployment..."

          # Deploy and capture both output and exit code using JSON for reliable parsing
          DEPLOY_OUTPUT=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }} --json) || DEPLOY_EXIT_CODE=$?

          # Check if deployment succeeded
          if [ -z "${DEPLOY_EXIT_CODE:-}" ]; then
            DEPLOY_EXIT_CODE=0
          fi

          echo "Deploy output:"
          echo "$DEPLOY_OUTPUT"

          if [ $DEPLOY_EXIT_CODE -eq 0 ]; then
            # Parse JSON output to extract deployment information
            DEPLOYMENT_URL=$(echo "$DEPLOY_OUTPUT" | jq -r '.url // empty')
            DEPLOYMENT_ID=$(echo "$DEPLOY_OUTPUT" | jq -r '.id // .uid // empty')
            
            if [[ -n "$DEPLOYMENT_URL" && "$DEPLOYMENT_URL" != "null" && "$DEPLOYMENT_URL" =~ ^https?:// ]]; then
              echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
              echo "Preview deployed to: $DEPLOYMENT_URL"
              
              # Set deployment ID if available
              if [[ -n "$DEPLOYMENT_ID" && "$DEPLOYMENT_ID" != "null" ]]; then
                echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
                echo "Deployment ID: $DEPLOYMENT_ID"
              fi
            else
              echo "::warning::Could not extract deployment URL from JSON output"
              echo "deployment_url=unknown" >> $GITHUB_OUTPUT
            fi
          else
            echo "::error::Deployment failed with exit code: $DEPLOY_EXIT_CODE"
            exit 1
          fi

      - name: Create PR-specific alias
        id: alias
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          ALIAS_NAME="findconstructionstaffing-pr-${PR_NUMBER}"

          # Set alias for the deployment
          DEPLOYMENT_URL="${{ steps.deploy.outputs.deployment_url }}"

          # Guard against missing or invalid deployment URL
          if [[ -z "$DEPLOYMENT_URL" || "$DEPLOYMENT_URL" == "unknown" || "$DEPLOYMENT_URL" == "null" ]]; then
            echo "::error::Deployment URL not available ($DEPLOYMENT_URL) - skipping alias creation"
            exit 1
          fi

          vercel alias set "$DEPLOYMENT_URL" ${ALIAS_NAME} --token=${{ secrets.VERCEL_TOKEN }}

          ALIAS_URL="https://${ALIAS_NAME}.vercel.app"
          echo "alias_url=$ALIAS_URL" >> $GITHUB_OUTPUT
          echo "Alias created: $ALIAS_URL"

      - name: Create deployment record
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'preview',
              description: 'Preview deployment for PR #${{ github.event.pull_request.number }}',
              auto_merge: false,
              required_contexts: [],
              transient_environment: true,
              production_environment: false
            });

            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: 'success',
              environment_url: '${{ steps.alias.outputs.alias_url }}',
              description: 'Preview deployment successful'
            });

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentUrl = '${{ steps.deploy.outputs.deployment_url }}';
            const aliasUrl = '${{ steps.alias.outputs.alias_url }}';
            const comment = `### ðŸš€ Preview Deployment Ready!

            Your changes have been deployed to Vercel:

            ðŸ”— **Preview URL**: ${aliasUrl}
            ðŸ”— **Deployment URL**: ${deploymentUrl}

            | Status | Details |
            |--------|---------|
            | âœ… Build | Successful |
            | âœ… Deploy | Complete |
            | ðŸ” Environment | Preview |

            This preview will be automatically deleted when the PR is merged or closed.`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Preview Deployment Ready')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  deploy-production:
    name: Deploy Production
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [check-ci-status]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Vercel CLI
        run: |
          echo "Installing Vercel CLI..."
          npm install --global vercel@latest --loglevel=error 2>&1 | grep -v "npm warn deprecated" || true

          # Verify installation
          vercel --version || {
            echo "::error::Vercel CLI not found after installation"
            exit 1
          }

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project Artifacts
        run: |
          set -e  # Exit on any error
          echo "Starting Vercel production build..."

          # Run build without tee to avoid exit code issues
          vercel build --prod --token=${{ secrets.VERCEL_TOKEN }} > build.log 2>&1 || BUILD_RESULT=$?

          # If BUILD_RESULT is not set, the command succeeded
          if [ -z "${BUILD_RESULT:-}" ]; then
            BUILD_RESULT=0
          fi

          # Display the build log
          cat build.log

          # Check if build failed
          if [ $BUILD_RESULT -ne 0 ]; then
            echo "::error::Vercel build failed with exit code: $BUILD_RESULT"
            exit 1
          fi

          echo "âœ“ Vercel build command completed"

          # Verify build artifacts
          if [ ! -d ".vercel/output" ]; then
            echo "::error::Build output directory not found"
            ls -la .vercel/ || true
            exit 1
          fi

          if [ ! -f ".vercel/output/config.json" ]; then
            echo "::error::Build config.json not found"
            ls -la .vercel/output/ || true
            exit 1
          fi

          echo "âœ“ Build completed successfully"
          echo "âœ“ Build artifacts verified"

          # Ensure clean exit
          exit 0

      - name: Deploy Project Artifacts to Vercel
        id: deploy
        run: |
          # Store current deployment for potential rollback using JSON output
          CURRENT_DEPLOYMENT_JSON=$(vercel list --prod --token=${{ secrets.VERCEL_TOKEN }} --json || echo '{"deployments":[]}')
          CURRENT_DEPLOYMENT=$(echo "$CURRENT_DEPLOYMENT_JSON" | node -e "
            const data = JSON.parse(require('fs').readFileSync(0, 'utf-8'));
            const prodDeployments = (data.deployments || [])
              .filter(d => d.target === 'production' && d.state === 'READY')
              .sort((a, b) => new Date(b.created) - new Date(a.created));
            if (prodDeployments.length > 0) {
              console.log(prodDeployments[0].uid);
            }
          ")

          # Ensure previous_deployment is always set with a meaningful value
          if [[ -n "$CURRENT_DEPLOYMENT" && "$CURRENT_DEPLOYMENT" != "null" ]]; then
            echo "previous_deployment=$CURRENT_DEPLOYMENT" >> $GITHUB_OUTPUT
            echo "Found previous deployment: $CURRENT_DEPLOYMENT"
          else
            echo "previous_deployment=none" >> $GITHUB_OUTPUT
            echo "No previous deployment found"
          fi

          # Deploy to production using JSON output for reliable parsing
          echo "Deploying to production..."
          DEPLOYMENT_OUTPUT=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }} --json 2>&1)
          DEPLOYMENT_EXIT_CODE=$?

          if [ $DEPLOYMENT_EXIT_CODE -eq 0 ]; then
            # Parse JSON output to extract deployment information
            DEPLOYMENT_URL=$(echo "$DEPLOYMENT_OUTPUT" | jq -r '.url // empty')
            DEPLOYMENT_ID=$(echo "$DEPLOYMENT_OUTPUT" | jq -r '.uid // empty')
            
            # Validate we got the required information
            if [[ -n "$DEPLOYMENT_URL" && "$DEPLOYMENT_URL" != "null" ]]; then
              echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
              echo "Production deployed to: $DEPLOYMENT_URL"
            else
              # Fallback to known production URL for production deployments
              DEPLOYMENT_URL="https://findconstructionstaffing.vercel.app"
              echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
              echo "Production deployed to: $DEPLOYMENT_URL (using fallback URL)"
            fi
            
            # Set deployment ID - use actual deployment UID for rollback functionality
            if [[ -n "$DEPLOYMENT_ID" && "$DEPLOYMENT_ID" != "null" ]]; then
              echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
              echo "Deployment ID: $DEPLOYMENT_ID"
            else
              # Try to extract deployment ID from JSON output using alternative field names
              DEPLOYMENT_ID=$(echo "$DEPLOYMENT_OUTPUT" | jq -r '.id // .deploymentId // empty')
              
              if [[ -n "$DEPLOYMENT_ID" && "$DEPLOYMENT_ID" != "null" ]]; then
                echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
                echo "Deployment ID: $DEPLOYMENT_ID"
              else
                echo "::warning::Could not determine deployment ID - rollback commands may not work"
                echo "deployment_id=unknown" >> $GITHUB_OUTPUT
              fi
            fi
            
            echo "âœ“ Deployment completed successfully"
          else
            echo "::error::Deployment failed with exit code: $DEPLOYMENT_EXIT_CODE"
            echo "Deployment output:"
            echo "$DEPLOYMENT_OUTPUT"
            exit 1
          fi

      - name: Create deployment record
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'production',
              description: 'Production deployment to Vercel',
              auto_merge: false,
              required_contexts: []
            });

      - name: Add deployment status
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentUrl = '${{ steps.deploy.outputs.deployment_url }}';

            // Get the deployment we just created
            const { data: deployments } = await github.rest.repos.listDeployments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              environment: 'production'
            });

            if (deployments.length > 0) {
              await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: deployments[0].id,
                state: 'success',
                environment_url: deploymentUrl,
                description: 'Deployment completed successfully'
              });
            }

      - name: Generate deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸš€ Production Deployment Complete

          ## Deployment Details
          - **Environment**: Production
          - **URL**: ${{ steps.deploy.outputs.deployment_url }}
          - **Deployment ID**: ${{ steps.deploy.outputs.deployment_id }}
          - **Previous Deployment**: ${{ steps.deploy.outputs.previous_deployment }}

          ## Commit Information
          - **SHA**: ${{ github.sha }}
          - **Author**: ${{ github.actor }}
          - **Message**: ${{ github.event.head_commit.message }}

          ## Next Steps
          1. Health checks will run automatically
          2. Monitor [Vercel Dashboard](https://vercel.com/dashboard)
          3. Check application logs for errors

          ## Rollback Instructions
          If issues are detected:
          \`\`\`bash
          vercel rollback ${{ steps.deploy.outputs.deployment_id }} --token=\$VERCEL_TOKEN
          \`\`\`
          EOF

      - name: Create deployment notification
        uses: actions/github-script@v7
        with:
          script: |
            const commit = context.payload.head_commit;
            const deploymentUrl = '${{ steps.deploy.outputs.deployment_url }}';

            // Create a deployment notification issue comment on the latest merged PR
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 5
            });

            const recentMergedPR = prs.find(pr => 
              pr.merged_at && 
              pr.merge_commit_sha === context.sha
            );

            if (recentMergedPR) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: recentMergedPR.number,
                body: `## ðŸŽ‰ Deployed to Production!
                
                Your changes have been successfully deployed to production.
                
                **Production URL**: https://findconstructionstaffing.com
                **Deployment URL**: ${deploymentUrl}
                
                Health checks are running and you'll be notified if any issues are detected.`
              });
            }

  check-ci-status:
    name: Check CI Status
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Check CI workflow status
        uses: actions/github-script@v7
        with:
          script: |
            // Get the latest CI workflow run for this commit
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci.yml',
              head_sha: context.sha,
              status: 'completed'
            });

            if (runs.workflow_runs.length === 0) {
              core.setFailed('No completed CI workflow found for this commit');
              return;
            }

            const latestRun = runs.workflow_runs[0];
            if (latestRun.conclusion !== 'success') {
              core.setFailed(`CI workflow failed with conclusion: ${latestRun.conclusion}`);
              return;
            }

            console.log('CI workflow passed successfully');
