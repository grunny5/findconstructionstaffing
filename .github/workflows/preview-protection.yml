name: Preview Environment Protection

on:
  pull_request:
    types: [opened, synchronize]

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  validate-preview:
    name: Validate Preview Environment
    runs-on: ubuntu-latest
    
    steps:
      - name: Check PR eligibility
        uses: actions/github-script@v7
        id: check
        with:
          script: |
            const pr = context.payload.pull_request;
            
            // Check if PR is from a fork
            const isFromFork = pr.head.repo.full_name !== pr.base.repo.full_name;
            
            // Check if PR has CI/CD label
            const labels = pr.labels.map(l => l.name);
            const hasDeployLabel = labels.includes('deploy-preview');
            
            // Check PR size
            const { data: prData } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });
            
            const isLargePR = prData.additions + prData.deletions > 1000;
            
            // Set outputs
            core.setOutput('is-fork', isFromFork);
            core.setOutput('has-label', hasDeployLabel);
            core.setOutput('is-large', isLargePR);
            
            // Determine if preview should be deployed
            let shouldDeploy = true;
            let reason = '';
            
            if (isFromFork && !hasDeployLabel) {
              shouldDeploy = false;
              reason = 'PRs from forks require "deploy-preview" label';
            } else if (isLargePR && !hasDeployLabel) {
              shouldDeploy = false;
              reason = 'Large PRs (>1000 changes) require "deploy-preview" label';
            }
            
            core.setOutput('should-deploy', shouldDeploy);
            core.setOutput('reason', reason);
            
      - name: Update PR status
        if: steps.check.outputs.should-deploy == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const reason = '${{ steps.check.outputs.reason }}';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `### ⚠️ Preview Deployment Skipped
              
              ${reason}
              
              To enable preview deployment:
              1. Add the \`deploy-preview\` label to this PR
              2. Push a new commit or re-run the workflow
              
              This helps us manage deployment resources efficiently.`
            });
            
      - name: Set deployment gate
        uses: actions/github-script@v7
        with:
          script: |
            const shouldDeploy = '${{ steps.check.outputs.should-deploy }}' === 'true';
            
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Preview Deployment Gate',
              head_sha: context.payload.pull_request.head.sha,
              status: 'completed',
              conclusion: shouldDeploy ? 'success' : 'neutral',
              output: {
                title: shouldDeploy ? 'Preview deployment authorized' : 'Preview deployment skipped',
                summary: shouldDeploy 
                  ? 'This PR is eligible for preview deployment'
                  : '${{ steps.check.outputs.reason }}'
              }
            });